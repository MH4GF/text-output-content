---
title: "graphql-rubyã§ã€queryã ã‘ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«ã«æ¥ç¶šã™ã‚‹"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ruby,graphqlruby,rails]
published: true
---

Railsã®[ãƒãƒ«ãƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹](https://guides.rubyonrails.org/active_record_multiple_databases.html)æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—Writerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨Readerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ†ã‘ã¦åˆ©ç”¨ã—ã¦ã„ã‚‹Railsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®GraphQLã‚¯ã‚¨ãƒªãŒãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã‹è¡Œã‚ãªã„ã®ã§ã‚ã‚Œã°Readerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«è‡ªå‹•ã§æ¥ç¶šã™ã‚‹ã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚

# Why

- Writerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è² è·è»½æ¸›ã®ãŸã‚ã€Readerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¯èƒ½ãªé™ã‚Šåˆ©ç”¨ã—ãŸã„ã€‚
- `ActiveRecord::Base.connected_to(role: :reading)` ã‚’åˆ©ç”¨ã›ãšã€è‡ªå‹•ã§æ©Ÿæ¢°çš„ã«DBãƒ­ãƒ¼ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„ã€‚
  - åˆ©ç”¨è€…ã®è£é‡ã«å§”ã­ã‚‹ã¨ãªã‚‹ã¨åˆ‡ã‚Šæ›¿ãˆã®æ¼ã‚ŒãŒç™ºç”Ÿã™ã‚‹ãŸã‚

# è§£æ±ºç­–

## å®Ÿè£…

```ruby
module Tracers
  class DatabaseRoleSelector
    EVENT_NAME = 'execute_multiplex'.freeze

    # @param [String] event
    # @param [Hash] data
    # @option data [GraphQL::Execution::Multiplex] multiplex
    def trace(event, data, &block)
      if event == EVENT_NAME
        multiplex = data[:multiplex]
        role = if multiplex.queries.all?(&:query?)
                 ActiveRecord::Base.reading_role
               else
                 ActiveRecord::Base.writing_role
               end

        Rails.logger.debug("[#{self.class.name}] ActiveRecord::Base.connected_to(role: #{role.inspect})")
        ActiveRecord::Base.connected_to(role: role, &block)
      else
        yield
      end
    end
  end
end

# app/graphql/my_schema.rb
class MySchema < GraphQL::Schema
  tracer Tracers::DatabaseRoleSelector.new
end
```
## è§£èª¬

### Trancers

graphqlâ€“rubyã®tracingã¨ã„ã†ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

https://graphql-ruby.org/queries/tracing.html

ã“ã‚Œã¯GraphQLã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦rackãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢çš„ã«ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã™ã‚‹ä»•çµ„ã¿ã§ã€`trace` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã€å‡¦ç†ã‚’è¿½åŠ ã—ãŸå¾Œ `yield` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦å‰å‡¦ç†ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

Datadogç­‰ã®ç›£è¦–ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¯ã‚¨ãƒªã®è¿½è·¡ã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚


`event`ã¯ã‚¤ãƒ™ãƒ³ãƒˆåã‚’è¡¨ã—ã¾ã™ã€‚ä¸€è¦§ã¯ã“ã¡ã‚‰ã§ã™ï¼š [https://graphql-ruby.org/api-doc/2.0.9/GraphQL/Tracing](https://graphql-ruby.org/api-doc/2.0.9/GraphQL/Tracing)

`data` ã¯å¾Œè¿°ã—ã¾ã™ã€‚

## multiplex

dataãƒãƒƒã‚·ãƒ¥ã®ä¸­ã®multiplexã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

https://graphql-ruby.org/queries/multiplex.html

multiplexã¯ã€Clientã‹ã‚‰è¤‡æ•°ã®ã‚¯ã‚¨ãƒªãŒãƒãƒƒãƒçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸå ´åˆã§ã‚‚å‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ãªä»•çµ„ã¿ã§ã™ã€‚

ã¨ã¯ã„ãˆã€GraphQLã®å…¨ã¦ã®ã‚¯ã‚¨ãƒªã¯multiplexã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒƒãƒã‚’æ„å›³ã—ã¦ã„ãªãã¨ã‚‚ã€1ã¤ã®è¦ç´ ã‚’å«ã‚€é…åˆ—ã¨ã—ã¦æ¸¡ã£ã¦ãã¾ã™ã€‚

## database role

database roleã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯ã€multiplexã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®queriesãŒå…¨ã¦ã‚¯ã‚¨ãƒªã§ã‚ã‚‹ï¼ˆ== readã®ã¿ã‚’è¡Œã†ã‚¯ã‚¨ãƒªã§ã‚ã‚‹ï¼‰å ´åˆã¯Readerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã—ã¾ã™ã€‚

## ã¾ã æ¤œè¨ã—ã¦ã„ãªã„ã“ã¨

### queryã ãŒDBã®writeãŒã—ãŸã„ã€‚è¿‚å›ã§ããªã„ã‹ï¼Ÿ

- writeå‡¦ç†ã¯æœ¬å½“ã«queryã§å¿…è¦ã§ã™ã‹ï¼Ÿmutationã«åˆ†å‰²ã§ãã¾ã›ã‚“ã‹ï¼Ÿ
- å¿…è¦ã«ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è€ƒãˆã‚‹ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚è¿‚å›ã§ãã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

## DBåˆ†å‰²ã‚’ã™ã‚‹ãªã©ã€é•ã†DBã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¦‹ã‚‹å¿…è¦ãŒå‡ºã¦ããŸ

- ä½•ã‹ã—ã‚‰ã®ãƒ•ãƒ©ã‚°ã‚’è¦‹ã¦ã©ã®DBã«æ¥ç¶šã™ã‚‹ã‹åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚

# å‚è€ƒ

https://github.com/rmosolgo/graphql-ruby/issues/2929

- ãƒãƒ«ãƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒãƒ¼ãƒˆã«ã¤ã„ã¦è­°è«–ã•ã‚Œã¦ã„ã‚‹Issueã§ã™ã€‚ä»Šå›ã®å®Ÿè£…ã®å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
- ãƒãƒ«ãƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒãƒ¼ãƒˆã‚’graphql-rubyå´ã§å–ã‚Šè¾¼ã‚€ã“ã¨ã¯è€ƒãˆã¦ãŠã‚‰ãšã€åˆ©ç”¨è€…å´ã§ã‚ªãƒ—ãƒˆã‚¤ãƒ³ã—ã¦ã»ã—ã„ã¨ã®ã“ã¨ã§ã—ãŸã€‚
