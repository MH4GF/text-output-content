---
title: "GitHub Container Registryã¸ã®docker loginã§GitHub CLIã®èªè¨¼æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [docker,ghcr,github]
published: true
---

GitHub Container Registryã¯GitHubã‚’åˆ©ç”¨ã—ã¦é–‹ç™ºã—ã¦ã„ã‚‹å ´åˆã¯å¤§å¤‰ä¾¿åˆ©ãªã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã§ã™ã€‚ä¾‹ãˆã°ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹æ¨©é™ã‚’Organizationã‚„Teamå˜ä½ã§ç°¡å˜ã«åˆ¶å¾¡ã§ããŸã‚Šã€GitHub ActionsçµŒç”±ã§ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚‚ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

æ°—ã«ãªã‚‹ç‚¹ãŒã‚ã‚‹ã¨ã™ã‚Œã°ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’docker pullã™ã‚‹ãŸã‚ã«ã¯GitHub Container Registryã¸ã®docker loginãŒå¿…è¦ã§ã™ãŒã€ãã®éš›ã«Private Access Token(PAT)ãŒè¦æ±‚ã•ã‚Œã¦ã—ã¾ã†ç‚¹ã§ã™ã€‚

https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-to-the-container-registry

é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹ã®ä¸­ã§ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ã«PATã®ç™ºè¡Œã¨ç®¡ç†ã‚’å¼·ã„ã‚‹ã“ã¨ã«ãªã‚‹ã®ã¯ã§ãã‚‹ã ã‘é¿ã‘ãŸã„ã§ã™ã€‚

ãã‚“ãªä¸­ã€è¿‚å›ç­–ã®ä¸€ã¤ã¨ã—ã¦GitHub CLIã®èªè¨¼æƒ…å ±ã‚’åˆ©ç”¨ã—ã¦docker loginã™ã‚‹æ–¹æ³•ãŒexperimentalã§ã¯ã‚ã‚‹ã‚‚ã®ã®GitHub CLIã®Issueã§ç´¹ä»‹ã•ã‚Œã¦ã„ãŸãŸã‚ã€æ—¥æœ¬èªã§ã‚‚ç´¹ä»‹ã—ã¾ã™ã€‚

https://gist.github.com/mislav/e154d707db230dc882d7194ec85d79f6
https://github.com/cli/cli/issues/5150

# æ‰‹é †ã®å…¨ä½“åƒ

1. PATHé…ä¸‹ã« `docker-credential-gh` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹
2. ~/.docker/config.jsonã«ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®è¨­å®šã‚’è¿½åŠ ã™ã‚‹
3. docker login ghcr.io

## PATHé…ä¸‹ã« `docker-credential-gh` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ã¦ãŠãã¾ã™ã€‚

```bash:/usr/local/bin/docker-credential-gh
#!/bin/bash
# This "docker-credential-gh" utility should exist an as executable somewhere in PATH.
#
# Dependencies: gh
#
set -e

cmd="$1"
if [ "erase" = "$cmd" ]; then
  cat - >/dev/null
  exit 0
fi
if [ "store" = "$cmd" ]; then
  cat - >/dev/null
  exit 0
fi
if [ "get" != "$cmd" ]; then
  exit 1
fi

host="$(cat -)"
host="${host#https://}"
host="${host%/}"
if [ "$host" != "ghcr.io" ] && [ "$host" != "docker.pkg.github.com" ]; then
  exit 1
fi

token="$(gh config get -h github.com oauth_token)"
if [ -z "$token" ]; then
  exit 1
fi

printf '{"Username":"%s", "Secret":"%s"}\n' "$(gh config get -h github.com user)" "$token"
```

## ~/.docker/config.jsonã«ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®è¨­å®šã‚’è¿½åŠ ã™ã‚‹

dockerãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ã¦ã„ã‚‹å ´åˆ `~/.docker/config.json` ãŒã‚ã‚‹ã¯ãšã§ã™ã®ã§ã€ãã“ã«ä»¥ä¸‹ã®å†…å®¹ã‚’åŠ ç­†ã—ã¾ã™ã€‚

```diff json:~/.docker.config.json
{
        ~ çœç•¥ ~
+       "credsStore": "desktop",
+       "credHelpers": {
+               "docker.pkg.github.com": "gh",
+               "ghcr.io": "gh"
+       }
}
```

credHelpersã®ã‚­ãƒ¼ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã—ã€å€¤ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã¨ã€docker engineã¯æŒ‡å®šã—ãŸãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®è³‡æ ¼æƒ…å ±ã®å–å¾—ã§ `docker-credential-<value>` ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ãã‚Œã‚’åˆ©ç”¨ã— `ghcr.io` ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã«ã¯1ã®å·¥ç¨‹ã§ä½œæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã•ã›ã¾ã™ã€‚

https://matsuand.github.io/docs.docker.jp.onthefly/engine/reference/commandline/login/#credentials-store

## docker login

ghcr.ioã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚ `Login Succeeded` ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

```bash
$ docker login ghcr.io
Authenticating with existing credentials...
Login Succeeded
```

ã“ã‚Œã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã®pull/pushãŒã§ãã‚‹ã¯ãšã§ã™ã€‚

# è£œè¶³

å…ƒã€…ã¯GitHub CLIã§ `gh auth configure-docker` ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’æä¾›ã—ã€ä¸Šè¨˜ã®æ‰‹é †ã‚’GitHub CLIå´ã§è¡Œã†ãŸã‚ã®è­°è«–ãŒé€²ã‚ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚
ã—ã‹ã— `gh` ã®å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…ãšPATHã¸ã®æ›¸ãè¾¼ã¿ãŒã§ãã‚‹ã¨ä»®å®šã™ã‚‹ã®ã¯å®‰å…¨ã§ã¯ãªã„ã¨ã—è­°è«–ãŒæ­¢ã¾ã£ã¦ã„ã¾ã™ã€‚
